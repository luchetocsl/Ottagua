---
// Import environment variables - must be prefixed with PUBLIC_ to be available in client-side code
const PLUNK_API_KEY = import.meta.env.PUBLIC_PLUNK_API_KEY;
---

<!-- Replace the API key placeholder in the script -->
<script define:vars={{ PLUNK_API_KEY }}>
  // Make the API key available to the script
  // @ts-ignore - Adding property to window
  window.PLUNK_API_KEY = PLUNK_API_KEY;
</script>

<section class="bg-cream w-full min-h-[70vh] flex items-center">
	<main class="flex justify-end items-center h-full w-full max-w-[1240px] mx-auto px-4">
		<div class="flex flex-col gap-6 p-8 mr-8 ml-auto max-w-3xl text-red md:mr-16 lg:mr-24">
			<h1 class="text-5xl font-bold leading-tight md:text-6xl lg:text-7xl">La guía de supervivencia para latinos en Ottawa</h1>
			<p class="max-w-prose text-lg">
				Suscríbete al único newsletter con todo lo que necesitas saber
				para sobrevivir a la Capital de Canadá.
			</p>
			<form class="flex flex-col gap-2 max-w-md" id="hero-form">
				<input type="hidden" name="event" value="subscription" />
				<input type="hidden" name="redirect" value="/"/>
				<div class="flex flex-col gap-2 md:flex-row">
					<input 
						type="text" 
						name="name" 
						placeholder="Tu nombre (opcional)" 
						class="flex-1 px-4 py-2 text-sm rounded-full border transition-colors outline-none border-red text-red focus:border-red-accent"
					/>
          <input 
						type="email" 
						name="email" 
						placeholder="tu@email.com" 
						required 
						class="flex-1 px-4 py-2 text-sm rounded-full border transition-colors outline-none border-red text-red focus:border-red-accent"
					/>
          
					<button 
						type="submit" 
						class="inline-flex gap-1 justify-center items-center px-6 py-2 text-sm rounded-full border-none transition-all cursor-pointer w-fit bg-red text-cream hover:bg-red-accent"
					>
						Suscríbete <i class='ri-arrow-right-up-line'></i>
					</button>
				</div>
				<div id="hero-form-message" class="h-4 text-xs"></div>
			</form>
		</div>
	</main>
</section>

<!-- All styling now handled by Tailwind classes -->

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('hero-form') as HTMLFormElement;
    const messageDiv = document.getElementById('hero-form-message');
    
    if (!form || !messageDiv) return;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Get form data
      const formData = new FormData(form);
      // @ts-ignore - Using window property
      formData.append('api_key', window.PLUNK_API_KEY || '');
      
      // Check if email is provided
      const emailValue = formData.get('email');
      if (!emailValue) {
        messageDiv.textContent = 'Error: El correo electrónico es requerido';
        messageDiv.style.color = 'var(--red-accent)';
        return;
      }
      
      // Get email from form as string
      const email = emailValue.toString();
      
      // Get name from form (if provided)
      const nameValue = formData.get('name');
      const name = nameValue ? nameValue.toString() : '';
      
      // Prepare data in the format expected by Plunk API
      const requestData = {
        event: 'subscription',
        email: email,
        subscribed: true,
        data: {
          name: name
        }
      };
      
      try {
        // Send the request with proper headers as per Plunk API docs
        const response = await fetch('https://api.useplunk.com/v1/track', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // @ts-ignore - Using window property
            'Authorization': `Bearer ${window.PLUNK_API_KEY || ''}`
          },
          body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
          // Success
          messageDiv.textContent = '¡Gracias por suscribirte!';
          messageDiv.style.color = 'var(--red)';
          form.reset();
          
          // Redirect to the gracias page
          window.location.href = '/gracias';
        } else {
          // Handle error
          const errorData = await response.json();
          console.error('Submission error:', errorData);
          
          // Show user-friendly error message
          if (errorData.message && errorData.message.includes('Email is required')) {
            messageDiv.textContent = 'Error: El correo electrónico es requerido';
          } else {
            messageDiv.textContent = `Error: ${errorData.message || 'Hubo un problema al procesar tu solicitud'}`;
          }
          messageDiv.style.color = 'var(--red-accent)';
        }
      } catch (error) {
        // Handle network errors
        messageDiv.textContent = 'Error de conexión. Por favor, intenta de nuevo más tarde.';
        messageDiv.style.color = 'var(--red-accent)';
        console.error('Submission error:', error);
      }
    });
  });
</script>



