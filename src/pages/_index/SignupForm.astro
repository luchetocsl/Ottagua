---
// Import environment variables - must be prefixed with PUBLIC_ to be available in client-side code
const PLUNK_API_KEY = import.meta.env.PUBLIC_PLUNK_API_KEY;
---

<!-- Replace the API key placeholder in the script -->
<script define:vars={{ PLUNK_API_KEY }}>
  // @ts-ignore - Adding property to window
  window.PLUNK_API_KEY = PLUNK_API_KEY;
</script>

<section class="flex justify-center items-center w-full" id="signup">
	<div class="max-w-[1240px] w-full mx-auto px-4 py-16">
		<div class="flex flex-col justify-center items-center mx-auto w-full max-w-3xl">
			<h3 class="mb-8 text-2xl font-semibold text-center text-red">Suscríbete</h3>
			
			<div class="flex flex-col gap-12 justify-center items-center w-full md:flex-row">
				<div class="w-full md:w-1/2">
					<div class="mx-auto max-w-md">
						<p class="mb-4 text-lg text-red">
							Por el momento, tengo pensado escribir sobre inmigración,
							restaurantes nuevos o eventos organizados por las embajadas de
							nuestros países. También me gustaría incluir torneos deportivos
							o fiestas pero quiero conocer tu opinión. Estoy abierto a todas
							las sugerencias.
						</p>
						<p class="text-lg text-red">
							Si quieres recomendarme donde buscar noticias, puedes hacerlo
							aquí: <a href='/help/' class="underline transition-colors text-red hover:text-red-accent">Ayuda a Ottagua</a>
						</p>
					</div>
				</div>

				<div class="w-full md:w-1/2">
					<div class="p-5 mx-auto max-w-md rounded-lg border border-red bg-cream">
						<form class="flex flex-col gap-3" id="plunk-form">
							<input type="hidden" name="event" value="subscription" />
							<input type="hidden" name="redirect" value="/" />
							<div class="flex flex-col gap-1">
								<label for="name-input" class="text-sm text-red">Nombre (opcional)</label>
								<input 
									id="name-input"
									type="text" 
									name="name" 
									placeholder="Tu nombre" 
									autocomplete="name"
									class="px-4 py-2 text-sm rounded-full border transition-colors outline-none border-red focus:border-red-accent"
								/>
							</div>
              
              <div class="flex flex-col gap-1">
								<label for="email-input" class="text-sm text-red">Correo electrónico</label>
								<input 
									id="email-input"
									type="email" 
									name="email" 
									placeholder="tu@email.com" 
									required 
									autocomplete="email"
									class="px-4 py-2 text-sm rounded-full border transition-colors outline-none border-red focus:border-red-accent"
								/>
							</div>
							
							<button 
								type="submit" 
								class="px-6 py-2 mt-1 text-sm rounded-full border-none transition-colors cursor-pointer bg-red text-cream hover:bg-red-accent"
							>
								Suscríbete
							</button>
							
						</form>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>

<!-- All styling now handled by Tailwind classes -->

<script>
  // Get the API key from the window object
  
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.getElementById('plunk-form') as HTMLFormElement;
    if (!form) return;
    
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Get form data
      const formData = new FormData(form);
      // @ts-ignore - Using window property
      formData.append('api_key', window.PLUNK_API_KEY || '');
      
      // Check if email is provided
      const emailValue = formData.get('email');
      if (!emailValue) {
        alert('Error: El correo electrónico es requerido');
        return;
      }
      
      // Get email and name from form
      const email = emailValue.toString();
      const name = formData.get('name')?.toString() || '';
      
      // Prepare data in the format expected by Plunk API
      const requestData = {
        event: 'subscription',
        email: email,
        subscribed: true,
        data: {
          name: name
        }
      };
      
      try {
        // Send the request with proper headers as per Plunk API docs
        const response = await fetch('https://api.useplunk.com/v1/track', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // @ts-ignore - Using window property
            'Authorization': `Bearer ${window.PLUNK_API_KEY || ''}`
          },
          body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
          // Success - reset form and redirect to the gracias page
          form.reset();
          window.location.href = '/gracias';
        } else {
          // Handle error
          const errorData = await response.json();
          console.error('Submission error:', errorData);
          
          // Show user-friendly error message as an alert
          if (errorData.message && errorData.message.includes('Email is required')) {
            alert('Error: El correo electrónico es requerido');
          } else {
            alert(`Error: ${errorData.message || 'Hubo un problema al procesar tu solicitud'}`);
          }
        }
      } catch (error) {
        // Handle network errors with alert
        alert('Error de conexión. Por favor, intenta de nuevo más tarde.');
        console.error('Submission error:', error);
      }
    });
  });
</script>
