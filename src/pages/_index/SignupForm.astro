---
// Import environment variables - must be prefixed with PUBLIC_ to be available in client-side code
const PLUNK_API_KEY = import.meta.env.PUBLIC_PLUNK_API_KEY;
---

<!-- Replace the API key placeholder in the script -->
<script define:vars={{ PLUNK_API_KEY }}>
	// @ts-ignore - Adding property to window
	window.PLUNK_API_KEY = PLUNK_API_KEY;
</script>

<section
	class='flex overflow-hidden justify-center items-center my-16 w-full signupform'
	id='signup'>
	<div class='max-w-[1240px] w-full mx-auto px-4'>
		<div class='flex flex-col justify-center items-center mx-auto w-full'>
			<div class='p-12 mx-auto max-w-xl'>
				<h3
					class='mb-8 text-5xl font-bold text-center md:text-6xl text-red'>
					Suscríbete
				</h3>
				<p class='mb-6 leading-relaxed text-left text-red'>
					En Ottagua comparto nuestras experiencias como familia
					mexicana viviendo en Ottawa: desde choques culturales y
					trámites, hasta restaurantes, eventos y pequeños
					descubrimientos del día a día.
				</p>
				<p class='mb-6 leading-relaxed text-left text-red'>
					Si hay algún tema que te gustaría que toque, ¡cuéntame!
					Estoy abierto a sugerencias.
				</p>
			</div>
			<form class='flex flex-col gap-6' id='hero-form'>
				<input type='hidden' name='event' value='subscription' />
				<input type='hidden' name='redirect' value='/' />
				<div class='flex flex-col gap-6 md:flex-row'>
					<input
						type='email'
						name='email'
						placeholder='tu@email.com'
						required
						class='flex-1 px-4 py-2 text-sm rounded-full border transition-colors outline-none border-red text-red focus:border-red-accent'
					/>
					<button
						type='submit'
						class='inline-flex gap-1 justify-center items-center px-6 py-2 text-sm rounded-full border-none transition-all cursor-pointer w-fit bg-red text-cream hover:bg-red-accent'>
						Suscríbete <i class='ri-arrow-right-up-line'></i>
					</button>
				</div>
				<div id='hero-form-message' class='h-4 text-xs'></div>
			</form>
		</div>
	</div>
</section>

<!-- All styling now handled by Tailwind classes -->

<script>
	// Get the API key from the window object

	document.addEventListener("DOMContentLoaded", () => {
		const form = document.getElementById("plunk-form") as HTMLFormElement;
		if (!form) return;

		form.addEventListener("submit", async (e) => {
			e.preventDefault();

			// Get form data
			const formData = new FormData(form);
			// @ts-ignore - Using window property
			formData.append("api_key", window.PLUNK_API_KEY || "");

			// Check if email is provided
			const emailValue = formData.get("email");
			if (!emailValue) {
				alert("Error: El correo electrónico es requerido");
				return;
			}

			// Get email and name from form
			const email = emailValue.toString();
			const name = formData.get("name")?.toString() || "";

			// Prepare data in the format expected by Plunk API
			const requestData = {
				event: "subscription",
				email: email,
				subscribed: true,
				data: {
					name: name,
				},
			};

			try {
				// Send the request with proper headers as per Plunk API docs
				const response = await fetch(
					"https://api.useplunk.com/v1/track",
					{
						method: "POST",
						headers: {
							"Content-Type": "application/json",
							// @ts-ignore - Using window property
							Authorization: `Bearer ${window.PLUNK_API_KEY || ""}`,
						},
						body: JSON.stringify(requestData),
					}
				);

				if (response.ok) {
					// Success - reset form and redirect to the gracias page
					form.reset();
					window.location.href = "/gracias";
				} else {
					// Handle error
					const errorData = await response.json();
					console.error("Submission error:", errorData);

					// Show user-friendly error message as an alert
					if (
						errorData.message &&
						errorData.message.includes("Email is required")
					) {
						alert("Error: El correo electrónico es requerido");
					} else {
						alert(
							`Error: ${errorData.message || "Hubo un problema al procesar tu solicitud"}`
						);
					}
				}
			} catch (error) {
				// Handle network errors with alert
				alert(
					"Error de conexión. Por favor, intenta de nuevo más tarde."
				);
				console.error("Submission error:", error);
			}
		});
	});
</script>

<script>
	import gsap from "gsap";
	import { ScrollTrigger } from "gsap/ScrollTrigger";
	gsap.registerPlugin(ScrollTrigger);

	document.addEventListener("DOMContentLoaded", function () {
		gsap.from(".signupform", {
			scrollTrigger: {
				trigger: ".signupform",
				start: "top 80%",
				end: "top 40%",
				scrub: 1,
			},
			y: 250,
			opacity: 0,
			ease: "power2.out",
		});
	});
</script>
